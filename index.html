<!DOCTYPE html>
<html lang="id">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content" />
	<title>AI ASISTEN</title>
	<meta name="description" content="Aplikasi Chat UI. Dibuat agar responsif, cepat, dan elegan." />
	<meta name="theme-color" content="#151515" />
	<link rel="manifest" href="manifest.json" />
	<link rel="apple-touch-icon" href="https://xdrqauwxvwooojufzndv.supabase.co/storage/v1/object/public/icons/icon-192i.png" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<meta name="apple-mobile-web-app-title" content="AI ASISTEN" />
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
	<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
	<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@900&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
	<style>
		/* --- RESET DASAR --- */
		html {
			overscroll-behavior: none;
			height: 100%;
			background-color: #151515;
		}
		body {
			font-family: "Inter", sans-serif;
			touch-action: manipulation;
			background-color: #151515;
			height: 100%;
			margin: 0;
			padding: 0;
			-webkit-user-select: none;
			user-select: none;
		}
		#chat-container {
			flex: 1;
			min-height: 0;
			overscroll-behavior-y: contain;
			-webkit-overflow-scrolling: touch;
			scrollbar-width: none;
			overflow-y: auto;
			scroll-behavior: auto !important;
		}
		#chat-messages {
			min-height: 100px;
			display: flex;
			flex-direction: column;
			justify-content: flex-end;
		}
		/* --- LAYOUT --- */
		.h-dynamic-screen {
			height: 100vh;
			height: 100dvh;
		}
		.min-h-dynamic-screen {
			min-height: 100vh;
			min-height: 100dvh;
		}
		/* --- INDIKATOR THINKING --- */
		.thinking-indicator {
			font-style: italic;
			color: #9ca3af;
			font-weight: 300;
			font-size: 0.875rem;
		}
		/* --- MARKDOWN TABLES --- */
		.ai-message-content table {
			border-collapse: separate;
			border-spacing: 0;
			width: 100%;
			margin-top: 1rem;
			margin-bottom: 1rem;
			border-radius: 0.5rem;
			overflow: hidden;
			border: 1px solid #404040;
		}
		.ai-message-content hr {
			margin-top: 1.25rem;
			margin-bottom: 1.25rem;
			border: 0;
			border-top: 1px solid #333333;
		}
		.ai-message-content th,
		.ai-message-content td {
			padding: 8px 12px;
			text-align: left;
			border: none;
			border-bottom: 1px solid #404040;
		}
		.ai-message-content th:not(:last-child),
		.ai-message-content td:not(:last-child) {
			border-right: 1px solid #404040;
		}
		.ai-message-content tr:last-child td {
			border-bottom: none;
		}
		.ai-message-content th {
			background-color: #272727;
			font-weight: 600;
		}
		.ai-message-content ul,
		.ai-message-content ol {
			margin-top: 0.5rem;
			margin-bottom: 0.5rem;
			padding-left: 2rem;
			list-style: revert;
		}
		/* --- SCROLLBAR HIDING --- */
		#settings-container {
			scrollbar-width: none;
		}
		#settings-container::-webkit-scrollbar {
			display: none;
		}
		/* --- RANGE SLIDER CUSTOM --- */
		.custom-range {
			-webkit-appearance: none;
			appearance: none;
			width: 100%;
			height: 2.25rem;
			background-color: transparent;
			cursor: pointer;
		}
		.custom-range::-webkit-slider-runnable-track {
			width: 100%;
			height: 2.25rem;
			background-color: #323232;
			border-radius: 0.5rem;
		}
		.custom-range::-webkit-slider-thumb {
			-webkit-appearance: none;
			appearance: none;
			height: 34px;
			width: 14px;
			background-color: #f3f4f6;
			border-radius: 8px;
			border: none;
			margin-top: 1px;
		}
		.custom-range::-moz-range-track {
			width: 100%;
			height: 2.25rem;
			background-color: #323232;
			border-radius: 0.5rem;
		}
		.custom-range::-moz-range-thumb {
			height: 40px;
			width: 10px;
			background-color: #f3f4f6;
			border-radius: 0.125rem;
			border: none;
		}
		/* --- OVERRIDE CSS: MATIKAN TOTAL SEMUA ANIMASI --- */
		.chat-bubble {
			opacity: 1 !important;
			transform: none !important;
			animation: none !important;
			transition: none !important;
		}
		@keyframes slideUpFade {
			from {
				opacity: 1;
			}
			to {
				opacity: 1;
			}
		}
		.typing-indicator span {
			height: 5px;
			width: 5px;
			background-color: #9ca3af;
			border-radius: 50%;
			display: inline-block;
			animation: bounce 1.4s infinite ease-in-out both;
			margin: 0 1px;
		}
		.typing-indicator .bounce1 {
			animation-delay: -0.32s;
		}
		.typing-indicator .bounce2 {
			animation-delay: -0.16s;
		}
		@keyframes bounce {
		    0%, 80%, 100% {
		        transform: scale(0);
		    }
		    40% {
		        transform: scale(1);
		    }
		}
		/* iPhone 13 mini, 12 mini, X, XS, 11 Pro (375px) */
		@media (max-width: 375px) and (min-height: 668px) {
		    #chat-app footer {
		        padding-top: 4px !important;
		        padding-bottom: 4px !important;
		        margin-bottom: 0px !important;
		    }
		}
		
		/* iPhone SE, 8, 7, 6s (375px Ã— 667px) */
		@media (max-width: 375px) and (max-height: 667px) {
		    #chat-app footer {
		        padding-top: 4px !important;
		        padding-bottom: 4px !important;
		        margin-bottom: 0px !important;
		    }
		}
	</style>
</head>
<body class="bg-[#151515]">
	<div id="loading-screen" class="flex items-center justify-center min-h-dynamic-screen">
		<svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
			<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
			<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
		</svg>
	</div>
	<div id="login-screen" class="hidden items-center justify-center min-h-dynamic-screen">
		<main class="w-full max-w-md mx-auto p-6">
			<div class="bg-[#212121] p-8 rounded-2xl shadow-lg">
				<div class="flex flex-col items-center mb-10">
					<div class="flex items-center justify-center h-16 w-16 rounded-full border border-neutral-700 bg-[#323232]">
						<svg class="h-8 w-8 text-gray-300" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
							<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
							<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
							<g id="SVGRepo_iconCarrier">
								<path d="M13.5 16.5854C13.5 17.4138 12.8284 18.0854 12 18.0854C11.1716 18.0854 10.5 17.4138 10.5 16.5854C10.5 15.7569 11.1716 15.0854 12 15.0854C12.8284 15.0854 13.5 15.7569 13.5 16.5854Z" fill="currentColor"></path>
								<path fill-rule="evenodd" clip-rule="evenodd" d="M5.94209 10.0005C5.93921 9.87333 5.9375 9.73733 5.9375 9.59375C5.9375 8.70739 6.00254 7.50382 6.27381 6.28307C6.54278 5.07271 7.03242 3.76302 7.94009 2.74189C8.8791 1.6855 10.2132 1 12 1C13.7868 1 15.1209 1.6855 16.0599 2.74189C16.9676 3.76302 17.4572 5.07271 17.7262 6.28307C17.9975 7.50382 18.0625 8.70739 18.0625 9.59375C18.0625 9.73733 18.0608 9.87333 18.0579 10.0005C19.688 10.0314 21 11.3625 21 13V20C21 21.6569 19.6569 23 18 23H6C4.34315 23 3 21.6569 3 20V13C3 11.3625 4.31196 10.0314 5.94209 10.0005ZM16.0573 10C16.0605 9.87465 16.0625 9.73868 16.0625 9.59375C16.0625 8.79261 16.0025 7.74618 15.7738 6.71693C15.5428 5.67729 15.1574 4.73698 14.5651 4.07061C14.0041 3.4395 13.2132 3 12 3C10.7868 3 9.9959 3.4395 9.43491 4.07061C8.84258 4.73698 8.45722 5.67729 8.22619 6.71693C7.99747 7.74618 7.9375 8.79261 7.9375 9.59375C7.9375 9.73868 7.93946 9.87465 7.94265 10H16.0573ZM19 13C19 12.4477 18.5523 12 18 12H6C5.44772 12 5 12.4477 5 13V20C5 20.5523 5.44772 21 6 21H18C18.5523 21 19 20.5523 19 20V13Z" fill="currentColor"></path>
							</g>
						</svg>
					</div>
				</div>
				<form id="login-form" class="space-y-4">
					<div>
						<input type="email" id="email" required class="w-full pl-4 py-3 rounded-xl focus:outline-none bg-[#323232] text-gray-100" placeholder="Email" />
					</div>
					<div>
						<input type="password" id="password" required class="w-full pl-4 py-3 rounded-xl focus:outline-none bg-[#323232] text-gray-100" placeholder="Password" />
					</div>
					<button type="submit" id="login-button" class="w-full bg-blue-700 text-white py-3 rounded-xl text-base font-medium transition-colors disabled:bg-gray-400">MASUK</button>
				</form>
				<p id="error-message" class="text-red-500 text-sm text-center hidden pt-4"></p>
			</div>
		</main>
	</div>
	<div id="chat-app" class="hidden h-dynamic-screen flex flex-col">
		<header class="bg-[#151515] border-b border-neutral-700 px-4 pb-4 shadow-sm" style="padding-top: calc(env(safe-area-inset-top) + 1rem);">
			<div class="flex items-center justify-between relative">
				<button id="sidebar-toggle-button" title="Buka Menu" class="text-gray-300 p-2 rounded-full text-sm font-medium">
					<svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
					</svg>
				</button>
				<div class="absolute left-1/2 -translate-x-1/2 flex flex-col items-center">
					<h1 class="text-xl font-black text-gray-300 -mb-1" style="font-family: 'Orbitron', sans-serif;">AI ASISTEN</h1>
				</div>
				<div class="flex items-center space-x-3">
					<button id="settings-button" title="Pengaturan" class="text-gray-300 p-2 rounded-full text-sm font-medium">
						<svg class="w-6 h-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
							<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
							<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
							<g id="SVGRepo_iconCarrier">
								<g>
									<path fill="none" d="M0 0h24v24H0z"></path>
									<path d="M12 14v2a6 6 0 0 0-6 6H4a8 8 0 0 1 8-8zm0-1c-3.315 0-6-2.685-6-6s2.685-6 6-6 6 2.685 6 6-2.685 6-6 6zm0-2c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm9 6h1v5h-8v-5h1v-1a3 3 0 0 1 6 0v1zm-2 0v-1a1 1 0 0 0-2 0v1h2z"></path>
								</g>
							</g>
						</svg>
					</button>
					<button id="logout-button" title="Keluar" class="text-gray-300 p-2 rounded-full text-sm font-medium">
						<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
							<path fill-rule="evenodd" clip-rule="evenodd" d="M2 6.5C2 4.01472 4.01472 2 6.5 2H12C14.2091 2 16 3.79086 16 6V7C16 7.55228 15.5523 8 15 8C14.4477 8 14 7.55228 14 7V6C14 4.89543 13.1046 4 12 4H6.5C5.11929 4 4 5.11929 4 6.5V17.5C4 18.8807 5.11929 20 6.5 20H12C13.1046 20 14 19.1046 14 18V17C14 16.4477 14.4477 16 15 16C15.5523 16 16 16.4477 16 17V18C16 20.2091 14.2091 22 12 22H6.5C4.01472 22 2 19.9853 2 17.5V6.5ZM18.2929 8.29289C18.6834 7.90237 19.3166 7.90237 19.7071 8.29289L22.7071 11.2929C23.0976 11.6834 23.0976 12.3166 22.7071 12.7071L19.7071 15.7071C19.3166 16.0976 18.6834 16.0976 18.2929 15.7071C17.9024 15.3166 17.9024 14.6834 18.2929 14.2929L19.5858 13L11 13C10.4477 13 10 12.5523 10 12C10 11.4477 10.4477 11 11 11L19.5858 11L18.2929 9.70711C17.9024 9.31658 17.9024 8.68342 18.2929 8.29289Z"></path>
						</svg>
					</button>
				</div>
			</div>
		</header>
		<div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/50 z-20"></div>
		<div id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-[#151515] shadow-lg z-30 transition-transform duration-300 ease-in-out -translate-x-full">
			<div class="px-4 pb-4" style="padding-top: calc(env(safe-area-inset-top) + 1rem);">
				<button id="new-chat-button" title="Percakapan Baru" class="w-full flex items-center justify-center bg-[#272727] text-gray-300 p-3 rounded-lg text-base font-medium hover:bg-neutral-700 transition-colors">
					<svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719"></path>
						<path d="M8 12h8"></path>
						<path d="M12 8v8"></path>
					</svg>
					<span>Percakapan Baru</span>
				</button>
				<div id="chat-history-list" class="mt-4 flex flex-col"></div>
			</div>
		</div>
		<main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6">
			<div id="chat-messages" class="max-w-3xl mx-auto flex flex-col space-y-4"></div>
		</main>
		<footer class="bg-[#151515] px-4 pt-4 pb-6">
			<div class="max-w-3xl mx-auto">
				<div id="file-preview-container" class="mb-3 grid grid-cols-2 md:grid-cols-4 gap-2"></div>
				<form id="chat-form">
					<div class="relative w-full">
						<button type="button" id="upload-button" class="absolute left-1 top-1/2 -translate-y-1/2 text-gray-400 focus:outline-none focus:ring-2 rounded-full p-2">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<line x1="12" y1="5" x2="12" y2="19"></line>
								<line x1="5" y1="12" x2="19" y2="12"></line>
							</svg>
						</button>
						<input type="text" id="chat-input" placeholder="Ketik pesan Anda..." autocomplete="off" class="flex-1 w-full pl-12 py-3 rounded-full focus:outline-none bg-[#272727] text-gray-300 pr-12" />
						<button type="submit" id="send-button" disabled class="absolute right-1 top-1/2 -translate-y-1/2 text-blue-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-full p-2 transition-all disabled:opacity-40 disabled:cursor-not-allowed">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<line x1="5" y1="12" x2="19" y2="12"></line>
								<polyline points="12 5 19 12 12 19"></polyline>
							</svg>
						</button>
					</div>
				</form>
			</div>
		</footer>
	</div>
	<div id="settings-page" class="hidden h-dynamic-screen flex flex-col">
		<header class="bg-[#151515] border-b border-neutral-700 px-4 pb-4 shadow-sm" style="padding-top: calc(env(safe-area-inset-top) + 1rem);">
			<div class="relative flex items-center justify-between h-10">
				<button id="settings-back-button" title="Kembali" class="z-10 text-gray-300 p-2 rounded-full text-sm font-medium hover:bg-neutral-800 transition-colors">
					<svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
					</svg>
				</button>
				<div class="absolute inset-0 flex items-center justify-center pointer-events-none">
					<h1 class="text-xl font-black text-gray-300" style="font-family: 'Orbitron', sans-serif;">ADMIN MENU</h1>
				</div>
				<div class="flex items-center space-x-3 z-10">
					<button id="settings-save-button" type="submit" form="settings-form" title="Simpan" class="text-green-500 p-2 rounded-full text-sm font-medium hover:bg-neutral-800 transition-colors">
						<svg class="w-5 h-5" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
							<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
							<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
							<g id="SVGRepo_iconCarrier">
								<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
									<g transform="translate(-152.000000, -515.000000)" fill="currentColor">
										<path d="M171,525 C171.552,525 172,524.553 172,524 L172,520 C172,519.447 171.552,519 171,519 C170.448,519 170,519.447 170,520 L170,524 C170,524.553 170.448,525 171,525 L171,525 Z M182,543 C182,544.104 181.104,545 180,545 L156,545 C154.896,545 154,544.104 154,543 L154,519 C154,517.896 154.896,517 156,517 L158,517 L158,527 C158,528.104 158.896,529 160,529 L176,529 C177.104,529 178,528.104 178,527 L178,517 L180,517 C181.104,517 182,517.896 182,519 L182,543 L182,543 Z M160,517 L176,517 L176,526 C176,526.553 175.552,527 175,527 L161,527 C160.448,527 160,526.553 160,526 L160,517 L160,517 Z M180,515 L156,515 C153.791,515 152,516.791 152,519 L152,543 C152,545.209 153.791,547 156,547 L180,547 C182.209,547 184,545.209 184,543 L184,519 C184,516.791 182.209,515 180,515 L180,515 Z"></path>
									</g>
								</g>
							</g>
						</svg>
					</button>
				</div>
			</div>
		</header>
		<main id="settings-container" class="flex-1 overflow-y-auto p-4 md:p-6">
			<div class="max-w-3xl mx-auto">
				<form id="settings-form" class="space-y-4">
					<div class="bg-[#212121] border border-neutral-700 rounded-lg p-4">
						<label class="block text-base font-medium text-gray-300 mb-1">Model Gemini</label>
						<p class="text-sm text-gray-400 mb-3">Pilih model AI yang akan digunakan. 'Flash' lebih cepat, 'Pro' lebih pintar.</p>
						<div class="relative">
							<button type="button" id="custom-model-button" class="flex w-full items-center justify-between rounded-lg bg-[#323232] px-3 py-2 text-left text-gray-100 focus:outline-none">
								<span id="custom-model-label">gemini 2.5 flash</span>
								<svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
									<path fill-rule="evenodd" d="M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zM10 17a.75.75 0 01-.55-.24l-3.25-3.5a.75.75 0 011.1-1.02L10 15.148l2.7-2.91a.75.75 0 011.1 1.02l-3.25 3.5A.75.75 0 0110 17z" clip-rule="evenodd" />
								</svg>
							</button>
							<div id="custom-model-options" class="hidden absolute z-10 mt-1 w-full overflow-hidden rounded-lg bg-[#272727] border border-neutral-700 shadow-lg max-h-60 overflow-y-auto">
								<div class="custom-model-option p-3 hover:bg-neutral-700 cursor-pointer text-gray-100" data-value="gemini-3-pro-preview">gemini 3 pro (terbaru)</div>
								<div class="custom-model-option p-3 hover:bg-neutral-700 cursor-pointer text-gray-100" data-value="gemini-2.5-pro">gemini 2.5 pro</div>
								<div class="custom-model-option p-3 hover:bg-neutral-700 cursor-pointer text-gray-100" data-value="gemini-2.5-flash">gemini 2.5 flash</div>
							</div>
						</div>
						<select id="setting-model" class="hidden">
							<option value="gemini-3-pro-preview">gemini 3 pro (terbaru)</option>
							<option value="gemini-2.5-pro">gemini 2.5 pro</option>
							<option value="gemini-2.5-flash" selected="">gemini 2.5 flash</option>
						</select>
					</div>
					<div class="bg-[#212121] border border-neutral-700 rounded-lg p-4">
						<label for="setting-prompt" class="block text-base font-medium text-gray-300 mb-1">Custom Prompt (System Instruction)</label>
						<p class="text-sm text-gray-400 mb-3">Instruksi kustom yang akan selalu diikuti oleh AI di setiap percakapan.</p>
						<div class="w-full rounded-lg border border-neutral-600 bg-[#323232] p-3">
							<textarea id="setting-prompt" rows="4" class="w-full focus:outline-none bg-transparent text-gray-100" placeholder="Contoh: Kamu adalah asisten APIP yang profesional..."></textarea>
						</div>
					</div>
					<div class="bg-[#212121] border border-neutral-700 rounded-lg p-4">
						<div class="flex justify-between items-center mb-1">
							<label for="setting-temp" class="text-base font-medium text-gray-300">Temperatur</label>
						</div>
						<p class="text-sm text-gray-400 mb-3">Mengatur kreativitas AI. Nilai rendah (0.0) lebih fokus, nilai tinggi (1.0) lebih acak.</p>
						<div class="relative w-full h-9 flex items-center">
							<span id="setting-temp-label" class="absolute left-1/2 -translate-x-1/2 text-sm font-mono font-medium text-gray-100 z-10 pointer-events-none select-none">0.7</span>
							<input id="setting-temp" type="range" min="0" max="1" step="0.1" value="0.7" class="custom-range w-full">
						</div>
					</div>
					<div class="bg-[#212121] border border-neutral-700 rounded-lg p-4">
						<label for="setting-tokens" class="block text-base font-medium text-gray-300 mb-1">Max Output Tokens</label>
						<p class="text-sm text-gray-400 mb-3">Batas token/kata untuk *jawaban* AI. Nilai lebih tinggi bolehkan jawaban panjang. (Maks: 8192)</p>
						<input id="setting-tokens" type="number" value="2048" class="w-full p-3 rounded-lg focus:outline-none bg-[#323232] text-gray-100">
					</div>
				</form>
				<div class="mt-4">
					<div class="bg-[#212121] border border-neutral-700 rounded-lg p-4 mb-4">
						<label class="block text-base font-medium text-gray-300 mb-1">Tambah Pengguna Baru</label>
						<p class="text-sm text-gray-400 mb-3">Buat akun baru secara manual untuk pengguna.</p>
						<div class="space-y-2">
							<input type="email" id="create-email-input" class="w-full p-3 rounded-lg focus:outline-none bg-[#323232] text-gray-100" placeholder="Email Pengguna">
							<input type="password" id="create-password-input" class="w-full p-3 rounded-lg focus:outline-none bg-[#323232] text-gray-100" placeholder="Password Pengguna">
							<button id="create-user-button" class="w-full bg-blue-700 text-white text-sm font-medium p-3 rounded-lg">TAMBAH PENGGUNA</button>
						</div>
					</div>
					<div class="bg-[#212121] border border-neutral-700 rounded-lg p-4">
						<h3 class="block text-base font-medium text-gray-300 mb-3">Daftar Pengguna</h3>
						<div id="user-list-container" class="space-y-2">
							<p id="user-list-loading" class="text-sm text-gray-400">Memuat daftar pengguna...</p>
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>
	<input type="file" id="file-input" accept=".pdf,.docx,.xls,.xlsx,.pptx,.txt,image/*" multiple class="hidden" />
	<div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
		<div class="absolute inset-0 bg-black/50"></div>
		<div class="relative bg-[#212121] w-full max-w-[18rem] rounded-2xl shadow-lg overflow-hidden">
			<div class="p-4">
				<h2 id="confirm-title" class="text-lg font-bold text-gray-100 text-center mb-2">Judul Konfirmasi</h2>
				<p id="confirm-message" class="text-gray-400 text-sm text-center">Pesan konfirmasi.</p>
			</div>
			<div class="border-t border-neutral-700 flex">
				<button id="modal-cancel-button" class="w-1/2 py-3 text-center text-sm font-medium text-indigo-400 font-bold border-r border-neutral-700">BATAL</button>
				<button id="modal-agree-button" class="w-1/2 py-3 text-center text-sm font-medium text-red-500 font-bold">SETUJU</button>
			</div>
		</div>
	</div>
	<div id="alert-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
		<div class="absolute inset-0 bg-black/50"></div>
		<div class="relative bg-[#212121] w-full max-w-[18rem] rounded-2xl shadow-lg overflow-hidden">
			<div class="p-4">
				<h2 id="alert-title" class="text-lg font-bold text-gray-100 text-center mb-2">Pemberitahuan</h2>
				<p id="alert-message" class="text-gray-400 text-sm text-center">Isi pesan alert.</p>
			</div>
			<div class="border-t border-neutral-700 flex">
				<button id="alert-ok-button" class="w-full py-3 text-center text-sm font-medium text-indigo-400 font-bold">OK</button>
			</div>
		</div>
	</div>
	<script>
		// --- Inisialisasi Supabase ---
		const SUPABASE_URL = 'https://xdrqauwxvwooojufzndv.supabase.co';
		const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkcnFhdXd4dndvb29qdWZ6bmR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDQyNDgsImV4cCI6MjA3ODA4MDI0OH0.mH7MEeAggksdAlandZpwuyGPYo08SuuWkXoMXVvwSiI';
		const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
		// --- Inisialisasi PWA ---
		const manifestContent = {
			"name": "AI ASISTEN",
			"short_name": "AI ASISTEN",
			"start_url": ".",
			"display": "standalone",
			"background_color": "#151515",
			"theme_color": "#151515",
			"description": "Aplikasi Chat AI canggih.",
			"icons": [{
				"src": "https://xdrqauwxvwooojufzndv.supabase.co/storage/v1/object/public/icons/icon-48.png",
				"sizes": "48x48",
				"type": "image/png"
			}, {
				"src": "https://xdrqauwxvwooojufzndv.supabase.co/storage/v1/object/public/icons/icon-192i.png",
				"sizes": "192x192",
				"type": "image/png",
				"purpose": "any maskable"
			}, {
				"src": "https://xdrqauwxvwooojufzndv.supabase.co/storage/v1/object/public/icons/icon-152i.png",
				"sizes": "512x512",
				"type": "image/png"
			}]
		};
		const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifestContent)], {
			type: 'application/json'
		}));
		document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);
		// --- Selektor DOM ---
		const loginScreen = document.getElementById('login-screen');
		const loginForm = document.getElementById('login-form');
		const emailInput = document.getElementById('email');
		const passwordInput = document.getElementById('password');
		const loginButton = document.getElementById('login-button');
		const errorMessage = document.getElementById('error-message');
		const chatApp = document.getElementById('chat-app');
		const logoutButton = document.getElementById('logout-button');
		const loadingScreen = document.getElementById('loading-screen');
		const confirmModal = document.getElementById('confirm-modal');
		const modalCancelButton = document.getElementById('modal-cancel-button');
		const modalAgreeButton = document.getElementById('modal-agree-button');
		const alertModal = document.getElementById('alert-modal');
		const alertTitle = document.getElementById('alert-title');
		const alertMessage = document.getElementById('alert-message');
		const alertOkButton = document.getElementById('alert-ok-button');
		const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
		const sidebar = document.getElementById('sidebar');
		const sidebarOverlay = document.getElementById('sidebar-overlay');
		const chatForm = document.getElementById('chat-form');
		const chatInput = document.getElementById('chat-input');
		const chatMessages = document.getElementById('chat-messages');
		const chatContainer = document.getElementById('chat-container');
		const sendButton = document.getElementById('send-button');
		const uploadButton = document.getElementById('upload-button');
		const fileInput = document.getElementById('file-input');
		const filePreviewContainer = document.getElementById('file-preview-container');
		const settingsButton = document.getElementById('settings-button');
		const settingsForm = document.getElementById('settings-form');
		const settingsModel = document.getElementById('setting-model');
		const settingsPrompt = document.getElementById('setting-prompt');
		const settingsTemp = document.getElementById('setting-temp');
		const settingsTempLabel = document.getElementById('setting-temp-label');
		const settingsTokens = document.getElementById('setting-tokens');
		const settingsPage = document.getElementById('settings-page');
		const settingsBackButton = document.getElementById('settings-back-button');
		const customModelButton = document.getElementById('custom-model-button');
		const customModelLabel = document.getElementById('custom-model-label');
		const customModelOptions = document.getElementById('custom-model-options');
		const createEmailInput = document.getElementById('create-email-input');
		const createPasswordInput = document.getElementById('create-password-input');
		const createUserButton = document.getElementById('create-user-button');
		const userListContainer = document.getElementById('user-list-container');
		const userListLoading = document.getElementById('user-list-loading');
		// --- Variabel Global & State Aplikasi ---
		let userRole = 'user';
		let chatList = [];
		let activeChatId = null;
		let isNewChat = true;
		let uploadedFiles = [];
		let chatHistory = [];
		let appSettings = {
			model: 'gemini-2.5-flash',
			customPrompt: '',
			temperature: 0.7,
			maxTokens: 2048
		};
		let lastTouchEnd = 0;
		const markdownConverter = new showdown.Converter();
		markdownConverter.setOption('tables', true);
		let currentConfirmAction = () => {};
		// --- Pencegah Zoom Double-Tap Mobile ---
		document.addEventListener('touchend', (event) => {
			const now = Date.now();
			if(now - lastTouchEnd <= 300) {
				event.preventDefault();
			}
			lastTouchEnd = now;
		}, false);
		// --- Fungsi Utilitas ---
		const scrollToBottom = () => {
			const container = document.getElementById('chat-container');
			if(container) {
				const isOverflowing = container.scrollHeight > container.clientHeight;
				if(isOverflowing) {
					container.scrollTo({
						top: container.scrollHeight,
						behavior: 'auto'
					});
				}
			}
		};
		const formatFileSize = (bytes) => {
			if(bytes < 1024 * 1024) {
				return (bytes / 1024).toFixed(1) + ' KB';
			} else {
				return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
			}
		};
		const forceLayoutRedraw = () => {
			setTimeout(() => {
				window.scrollTo(0, 0);
			}, 30);
		};
		const extractTextFromSlideXML = (xmlString) => {
			try {
				const parser = new DOMParser();
				const xmlDoc = parser.parseFromString(xmlString, "application/xml");
				const textNodes = xmlDoc.getElementsByTagName("a:t");
				const textContent = Array.from(textNodes).map(node => node.textContent).join(' ');
				return textContent;
			} catch (e) {
				console.error("Error parsing slide XML:", e);
				return '';
			}
		};
		const renderFilePreviews = () => {
			filePreviewContainer.innerHTML = '';
			uploadedFiles.forEach((file, index) => {
				const fileSizeFormatted = formatFileSize(file.size);
				let iconSvg = '';
				const fileType = file.type;
				const mimeType = file.mimeType;
				if(mimeType.startsWith('image/')) {
					iconSvg = `<img src="data:${mimeType};base64,${file.data}" class="w-full h-full object-cover rounded-md" alt="preview" />`;
				} else if(mimeType === 'application/pdf' || fileType === 'pdf') {
					iconSvg = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><path fill="#EF4444" d="M20 8v12a2 2 0 01-2 2H6a2 2 0 01-2 -2V4a2 2 0 012-2h8l6 6z"/><path fill="#DC2626" d="M14 2v6h6L14 2z"/><text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="7" font-family="sans-serif" font-weight="bold">PDF</text></svg>`;
				} else if(mimeType.includes('word') || fileType === 'doc' || fileType === 'docx') {
					iconSvg = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><path fill="#3B82F6" d="M20 8v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h8l6 6z"/><path fill="#2563EB" d="M14 2v6h6L14 2z"/><text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="10" font-family="sans-serif" font-weight="bold">W</text></svg>`;
				} else if(mimeType.includes('excel') || mimeType.includes('spreadsheet') || fileType === 'xls' || fileType === 'xlsx') {
					iconSvg = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><path fill="#22C55E" d="M20 8v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h8l6 6z"/><path fill="#16A34A" d="M14 2v6h6L14 2z"/><text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="10" font-family="sans-serif" font-weight="bold">X</text></svg>`;
				} else if(mimeType.includes('powerpoint') || mimeType.includes('presentation') || fileType === 'ppt' || fileType === 'pptx') {
					iconSvg = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><path fill="#F97316" d="M20 8v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h8l6 6z"/><path fill="#EA580C" d="M14 2v6h6L14 2z"/><text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="10" font-family="sans-serif" font-weight="bold">P</text></svg>`;
				} else if(fileType === 'txt' || mimeType === 'text/plain') {
					iconSvg = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><path fill="#9CA3AF" d="M20 8v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h8l6 6z"/><path fill="#6B7280" d="M14 2v6h6L14 2z"/><text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="9" font-family="sans-serif" font-weight="bold">TXT</text></svg>`;
				} else {
					iconSvg = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><path fill="#6B7280" d="M20 8v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h8l6 6z"/><path fill="#4B5563" d="M14 2v6h6L14 2z"/><text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="7" font-family="sans-serif" font-weight="bold">FILE</text></svg>`;
				}
				const fileCard = `
		            <div class="file-preview-card bg-[#272727] text-gray-200 rounded-lg p-2 flex flex-row items-center relative text-sm shadow-sm cursor-pointer">
		                <div class="w-10 h-10 mr-2 flex-shrink-0 flex items-center justify-center overflow-hidden rounded bg-[#323232]">${iconSvg}</div>
		                <div class="overflow-hidden text-left flex-1 min-w-0">
		                    <div class="font-medium truncate text-xs" title="${file.name}">${file.name}</div>
		                    <div class="text-xs text-gray-400">${fileSizeFormatted}</div>
		                </div>
		                <button type="button" class="delete-file-button absolute top-0 right-0 -mt-2 -mr-2 rounded-full w-5 h-5 focus:outline-none text-neutral-600 hover:text-red-500" data-index="${index}">
		                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke="currentColor">
		                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
		                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
		                        <g id="SVGRepo_iconCarrier">
		                            <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"></path>
		                        </g>
		                    </svg>
		                </button>
		            </div>`;
				filePreviewContainer.innerHTML += fileCard;
			});
		};
		const renderChatList = () => {
			const chatHistoryListContainer = document.getElementById('chat-history-list');
			chatHistoryListContainer.innerHTML = '';
			chatList.forEach(chat => {
				const isActive = (chat.id == activeChatId);
				const titleColorClass = isActive ? 'text-blue-500' : 'text-gray-300';
				const chatItemHTML = `
		            <div class="chat-history-item flex items-center justify-between px-3 py-2 rounded-lg cursor-pointer" data-id="${chat.id}">
		                <span class="${titleColorClass} text-base truncate min-w-0">${chat.title}</span>
		                <button class="delete-chat-button text-gray-400 hover:text-red-500 opacity-0 invisible transition-all p-1 ml-2 flex-shrink-0" data-id="${chat.id}">
		                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
		                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
		                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
		                        <g id="SVGRepo_iconCarrier">
		                            <path d="M4 7.00005L10.2 11.65C11.2667 12.45 12.7333 12.45 13.8 11.65L20 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
		                            <path d="M13 19H5C3.89543 19 3 18.1046 3 17V7C3 5.89543 3.89543 5 5 5H19C20.1046 5 21 5.89543 21 7V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
		                            <path d="M17 16L19 18M21 20L19 18M19 18L21 16M19 18L17 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
		                        </g>
		                    </svg>
		                </button>
		            </div>
		        `;
				chatHistoryListContainer.innerHTML += chatItemHTML;
			});
		};
		const addMessage = (sender, message, isMarkdown = false) => {
			const msgDiv = document.createElement('div');
			msgDiv.className = 'chat-bubble px-4 py-2 rounded-xl w-full flex flex-col';

			const now = new Date();
			const timestamp = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
			const messageElement = document.createElement('div');

			if(sender === 'user') {
				const headerDiv = document.createElement('div');
				headerDiv.className = 'flex justify-between items-center mb-1';
				headerDiv.innerHTML = `<div class="text-sm font-bold text-blue-400">Anda</div>`;

				msgDiv.classList.add('text-gray-100', 'self-start', 'border', 'border-neutral-700', 'pb-2');
				msgDiv.appendChild(headerDiv);

				if(message) {
					messageElement.className = 'min-h-[1.5rem]';
					messageElement.textContent = message;
					msgDiv.appendChild(messageElement);
				}

				if(isMarkdown && typeof isMarkdown === 'string' && isMarkdown !== '') {
					const fileContainer = document.createElement('div');
					fileContainer.className = (message ? 'mt-2' : '') + ' grid grid-cols-2 md:grid-cols-4 gap-2';
					fileContainer.innerHTML = isMarkdown;
					fileContainer.querySelectorAll('.file-preview-card').forEach(card => card.classList.remove('cursor-pointer'));
					fileContainer.querySelectorAll('.delete-file-button').forEach(btn => btn.remove());
					msgDiv.appendChild(fileContainer);
				}

				const timeDiv = document.createElement('div');
				timeDiv.className = 'text-[12px] text-gray-500 mt-1 text-right';
				timeDiv.textContent = timestamp;
				msgDiv.appendChild(timeDiv);

			} else if(sender === 'ai') {
				const headerDiv = document.createElement('div');
				headerDiv.className = 'flex justify-between items-center mb-1';
				headerDiv.innerHTML = `<div class="text-sm font-bold text-white mb-1">Ai Asisten</div>`;

				msgDiv.classList.add('text-gray-100', 'self-start', 'border', 'border-neutral-700');
				messageElement.className = 'ai-message-content min-h-[1.5rem]';

				if(message === 'TYPING_PLACEHOLDER') {
					messageElement.innerHTML = `<div class="typing-indicator"><span class="bounce1"></span><span class="bounce2"></span><span></span></div>`;
				} else {
					messageElement.innerHTML = isMarkdown ? markdownConverter.makeHtml(message) : message;
				}

				const footerDiv = document.createElement('div');
				footerDiv.className = 'flex justify-between items-center mt-1';
				footerDiv.innerHTML = `
					<button class="copy-chat-button text-gray-400 focus:outline-none rounded invisible">
						<svg viewBox="0 0 1024 1024" width="14" height="14" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
							<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
							<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
							<g id="SVGRepo_iconCarrier">
								<path d="M768 832a128 128 0 0 1-128 128H192A128 128 0 0 1 64 832V384a128 128 0 0 1 128-128v64a64 64 0 0 0-64 64v448a64 64 0 0 0 64 64h448a64 64 0 0 0 64-64h64z"></path>
								<path d="M384 128a64 64 0 0 0-64 64v448a64 64 0 0 0 64 64h448a64 64 0 0 0 64-64V192a64 64 0 0 0-64-64H384zm0-64h448a128 128 0 0 1 128 128v448a128 128 0 0 1-128 128H384a128 128 0 0 1-128-128V192A128 128 0 0 1 384 64z"></path>
							</g>
						</svg>
					</button>
					<div class="text-[12px] text-gray-500 ai-timestamp">${timestamp}</div>
				`;

				msgDiv.appendChild(headerDiv);
				msgDiv.appendChild(messageElement);
				msgDiv.appendChild(footerDiv);
			}
			chatMessages.appendChild(msgDiv);
			return msgDiv;
		};
		// --- Fungsi Manajemen Aplikasi ---
		const initializeApp = async (session) => {
			if(!session) {
				showLoginScreen();
				return;
			}
			try {
				let [profileRes, settingsRes] = await Promise.all([
					supabase.from('profiles').select('role').eq('id', session.user.id).single(),
					supabase.from('global_settings').select('*').eq('id', 1).single()
				]);
				if(profileRes.error) throw profileRes.error;
				if(settingsRes.error) throw settingsRes.error;
				userRole = profileRes.data.role;
				appSettings.model = settingsRes.data.model;
				appSettings.customPrompt = settingsRes.data.custom_prompt;
				appSettings.temperature = settingsRes.data.temperature;
				appSettings.maxTokens = settingsRes.data.max_tokens;
				if(userRole === 'admin') {
					settingsButton.classList.remove('hidden');
				} else {
					settingsButton.classList.add('hidden');
				}
				await showChatApp(session.user.id, true);
			} catch (error) {
				console.error("Error initializing app:", error.message);
				showCustomAlert("Error", "Gagal memuat data pengguna. Silakan coba login kembali.");
				await supabase.auth.signOut();
				showLoginScreen();
			}
		};
		const showLoginScreen = () => {
			loadingScreen.classList.add('hidden');
			chatApp.classList.add('hidden');
			settingsPage.classList.add('hidden');
			loginScreen.classList.remove('hidden');
			loginScreen.classList.add('flex');
			chatMessages.innerHTML = '';
			chatHistory = [];
			uploadedFiles = [];
			renderFilePreviews();
			emailInput.value = '';
			passwordInput.value = '';
		};
		const showChatApp = async (userId, shouldFocus = true) => {
			loadingScreen.classList.add('hidden');
			loginScreen.classList.add('hidden');
			settingsPage.classList.add('hidden');
			loginScreen.classList.remove('flex');
			chatApp.classList.remove('hidden');
			try {
				if(chatList.length === 0) {
					const {
						data,
						error
					} = await supabase.from('conversations').select('id, title').eq('user_id', userId).order('created_at', {
						ascending: false
					});
					if(error) throw error;
					chatList = data || [];
				}
				renderChatList();
				const lastActiveId = localStorage.getItem('siapip_lastActiveId');
				const chatExists = lastActiveId && chatList.find(c => c.id === lastActiveId);
				if(chatExists) {
					if(activeChatId === lastActiveId && chatMessages.children.length > 0) {
						scrollToBottom();
					} else {
						activeChatId = lastActiveId;
						isNewChat = false;
						renderChatList();
						const {
							data: messages,
							error
						} = await supabase.from('messages').select('role, parts').eq('conversation_id', activeChatId).order('created_at', {
							ascending: true
						});
						if(error) throw error;
						chatMessages.innerHTML = '';
						chatHistory = messages || [];
						if(chatHistory.length > 0) {
							chatHistory.forEach(msg => {
								const txt = msg.parts.find(p => p.text)?.text || '';
								const file = msg.parts.find(p => p.fileHtml)?.fileHtml;
								addMessage(msg.role === 'user' ? 'user' : 'ai', txt, msg.role === 'user' ? file : true);
							});
						} else {
							addMessage('ai', 'Melanjutkan percakapan...', true);
						}
						scrollToBottom();
					}
				} else {
					startNewChat(false);
				}
				if(shouldFocus) setTimeout(() => chatInput.focus(), 50);
			} catch (error) {
				console.error("Error:", error.message);
			}
		};
		const handleLogin = async (e) => {
			e.preventDefault();
			loginButton.disabled = true;
			loginButton.textContent = 'Memproses...';
			errorMessage.textContent = '';
			errorMessage.classList.add('hidden');
			const {
				data,
				error
			} = await supabase.auth.signInWithPassword({
				email: emailInput.value,
				password: passwordInput.value,
			});
			if(error) {
				errorMessage.textContent = 'Email atau password salah.';
				errorMessage.classList.remove('hidden');
				loginButton.disabled = false;
				loginButton.textContent = 'MASUK';
			} else if(data.session) {
				await initializeApp(data.session);
			}
		};
		const handleLogout = async () => {
			const {
				error
			} = await supabase.auth.signOut();
			if(!error) {
				showLoginScreen();
			} else {
				console.error('Gagal logout:', error.message);
			}
		};
		const checkAuth = async () => {
			await new Promise(resolve => setTimeout(resolve, 2000));
			const {
				data: {
					session
				}
			} = await supabase.auth.getSession();
			if(session) {
				await initializeApp(session);
			} else {
				showLoginScreen();
			}
		};
		// --- Fungsi Chat ---
		const startNewChat = (shouldFocus = true) => {
			isNewChat = true;
			activeChatId = null;
			localStorage.removeItem('siapip_lastActiveId');
			chatHistory = [];
			uploadedFiles = [];
			renderChatList();
			renderFilePreviews();

			chatMessages.innerHTML = `
				<div class="flex flex-col items-center justify-center w-full h-[60vh] text-center select-none opacity-80">
					<h2 class="text-2xl font-bold text-blue-500 mb-2">Halo, Selamat Datang</h2>
					<p class="text-base text-gray-400">Bagaimana saya bisa membantu Anda hari ini?</p>
				</div>
			`;

			if(shouldFocus) {
				chatInput.focus();
			}
		};
		// --- Fungsi Modal & UI ---
		const showConfirmModal = () => {
			confirmModal.classList.remove('hidden');
		};
		const hideConfirmModal = () => {
			confirmModal.classList.add('hidden');
		};
		const showCustomAlert = (title, message) => {
			alertTitle.textContent = title;
			alertMessage.textContent = message;
			alertModal.classList.remove('hidden');
		};
		const showCustomConfirm = (title, message, onAgreeCallback) => {
			const confirmTitle = document.getElementById('confirm-title');
			const confirmMessage = document.getElementById('confirm-message');
			confirmTitle.textContent = title;
			confirmMessage.textContent = message;
			currentConfirmAction = onAgreeCallback;
			confirmModal.classList.remove('hidden');
		};
		const hideCustomAlert = () => {
			alertModal.classList.add('hidden');
		};
		const showSettingsPage = () => {
			settingsModel.value = appSettings.model;
			settingsPrompt.value = appSettings.customPrompt ?? '';
			settingsTemp.value = appSettings.temperature;
			settingsTempLabel.textContent = appSettings.temperature;
			settingsTokens.value = appSettings.maxTokens;
			const selectedOption = settingsModel.querySelector(`option[value="${appSettings.model}"]`);
			if(selectedOption) {
				customModelLabel.textContent = selectedOption.textContent;
			}
			chatApp.classList.add('hidden');
			settingsPage.classList.remove('hidden');
			loadUsers();
		};
		const openSidebar = () => {
			sidebar.classList.remove('-translate-x-full');
			sidebarOverlay.classList.remove('hidden');
		};
		const closeSidebar = () => {
			sidebar.classList.add('-translate-x-full');
			sidebarOverlay.classList.add('hidden');
		};
		// --- Fungsi Admin ---
		async function callAdminFunction(action, payload = {}) {
			const functionUrl = `${SUPABASE_URL}/functions/v1/admin-user-manager`;
			const {
				data: {
					session
				}
			} = await supabase.auth.getSession();
			const response = await fetch(functionUrl, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${session.access_token}`
				},
				body: JSON.stringify({
					action,
					payload
				}),
			});
			if(!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || "Gagal memanggil fungsi admin.");
			}
			return response.json();
		}
		async function renderUserList(users) {
			userListContainer.innerHTML = '';
			if(users.length === 0) {
				userListContainer.innerHTML = '<p class="text-sm text-gray-400">Tidak ada pengguna ditemukan.</p>';
				return;
			}
			const {
				data: {
					user: selfUser
				}
			} = await supabase.auth.getUser();
			const selfId = selfUser ? selfUser.id : null;
			users.forEach(user => {
				const isFrozen = user.banned_until && (new Date(user.banned_until) > new Date());
				const userCard = document.createElement('div');
				userCard.className = `flex items-center justify-between p-3 bg-[#323232] rounded-lg ${isFrozen ? 'opacity-50' : ''}`;
				const freezeAction = isFrozen ? 'unfreeze_user' : 'freeze_user';
				const freezeText = isFrozen ? 'Buka' : 'Freeze';
				const freezeClass = isFrozen ? 'bg-blue-900/50 text-blue-400 hover:text-blue-300' : 'bg-yellow-900/50 text-yellow-400 hover:text-yellow-300';
				userCard.innerHTML = `
		            <div class="min-w-0">
		                <p class="text-sm font-medium text-gray-100 truncate">${user.email}</p>
		                <p class="text-xs text-gray-400">${isFrozen ? '(FROZEN)' : `Role: ${user.role}`}</p>
		            </div>
		            <div class="flex space-x-2 flex-shrink-0">
		                <button class="freeze-toggle-button text-sm font-medium px-3 py-1 rounded-lg ${freezeClass}" 
		                        data-id="${user.id}" 
		                        data-email="${user.email}"
		                        data-action="${freezeAction}"
		                        ${user.id === selfId ? 'disabled' : ''}> ${freezeText}
		                </button>
		                <button class="delete-user-button text-red-500 hover:text-red-400 text-sm font-medium px-3 py-1 bg-red-900/50 rounded-lg" 
		                        data-id="${user.id}" 
		                        data-email="${user.email}"
		                        ${user.id === selfId ? 'disabled' : ''}> Hapus
		                </button>
		            </div>
		        `;
				userListContainer.appendChild(userCard);
			});
		}
		async function loadUsers() {
			try {
				userListContainer.innerHTML = '<p id="user-list-loading" class="text-sm text-gray-400">Memuat daftar pengguna...</p>';
				const usersWithRoles = await callAdminFunction('list_users');
				await renderUserList(usersWithRoles);
			} catch (error) {
				userListContainer.innerHTML = `<p class="text-sm text-red-400">Gagal memuat pengguna: ${error.message}</p>`;
			}
		}
		// --- Fungsi API AI ---
		async function callGeminiAPI(chatHistory, files) {
			const placeholder = addMessage('ai', 'TYPING_PLACEHOLDER');
			scrollToBottom();
			const {
				model,
				customPrompt,
				temperature,
				maxTokens
			} = appSettings;
			const functionUrl = `${SUPABASE_URL}/functions/v1/call-gemini`;
			const generationConfig = {
				temperature: parseFloat(temperature),
				maxOutputTokens: parseInt(maxTokens, 10),
			};
			const tools = [{
				google_search: {}
			}];
			const currentDate = new Date().toLocaleString('id-ID', {
				weekday: 'long',
				year: 'numeric',
				month: 'long',
				day: 'numeric',
				hour: '2-digit',
				minute: '2-digit',
				timeZoneName: 'short'
			});
			let baseSystemPrompt = `Current Date/Time: ${currentDate}. You are a helpful AI Assistant. You have access to Google Search. Use it for current events.`;
			if(customPrompt && customPrompt.trim() !== '') {
				baseSystemPrompt += `\n\nCustom Instruction: ${customPrompt}`;
			}
			const systemInstruction = {
				role: "system",
				parts: [{
					text: baseSystemPrompt
				}]
			};
			const contents = JSON.parse(JSON.stringify(chatHistory));
			contents.forEach(msg => {
				if(msg.parts) {
					msg.parts.forEach(p => {
						if(p.text && typeof p.text === 'string' && p.text.includes('<img src="data:')) {
							p.text = '[Info Sistem: User melihat gambar hasil AI di sini]';
						}
					});
				}
				if(msg.role === 'user') {
					const textPart = msg.parts.find(p => p.text);
					msg.parts = textPart ? [{
						text: textPart.text
					}] : [{
						text: "..."
					}];
				}
			});
			if(files.length > 0) {
				const lastUserMessage = contents[contents.length - 1];
				const originalUserText = (lastUserMessage.parts.length > 0 && lastUserMessage.parts[0].text) ? lastUserMessage.parts[0].text : '';
				let combinedTextContent = '';
				const fileParts = [];
				files.forEach(file => {
					if(file.isTextContent) {
						combinedTextContent += `[Lampiran Dokumen: ${file.name}]:\n---\n${file.data}\n---\n\n`;
					} else {
						fileParts.push({
							inlineData: {
								mimeType: file.mimeType,
								data: file.data
							}
						});
					}
				});
				lastUserMessage.parts = [{
					text: combinedTextContent + originalUserText
				}, ...fileParts];
			}
			const requestPayload = {
				contents: contents,
				generationConfig: generationConfig,
				tools: tools,
				systemInstruction: systemInstruction
			};
			try {
				const {
					data: {
						session
					}
				} = await supabase.auth.getSession();
				if(!session) throw new Error('Sesi tidak valid.');
				const response = await fetch(functionUrl, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${session.access_token}`
					},
					body: JSON.stringify({
						model: model,
						payload: requestPayload
					}),
				});
				if(!response.ok) {
					const errorData = await response.json().catch(() => ({}));
					throw new Error(errorData.error || `Server Error ${response.status}`);
				}
				const data = await response.json();
				if(!data.candidates || data.candidates.length === 0) {
					if(data.promptFeedback) throw new Error(`Blocked: ${JSON.stringify(data.promptFeedback)}`);
					throw new Error('AI tidak memberikan respon.');
				}
				const firstCandidate = data.candidates[0];
				let aiMessage = firstCandidate.content?.parts?.[0]?.text || " ";
				const messageElement = placeholder.querySelector('.ai-message-content');
				if(messageElement) {
					messageElement.innerHTML = markdownConverter.makeHtml(aiMessage);
					const timeElement = placeholder.querySelector('.ai-timestamp');
					if(timeElement) timeElement.textContent = new Date().toLocaleTimeString('id-ID', {
						hour: '2-digit',
						minute: '2-digit'
					});
				}
				scrollToBottom();
				const aiParts = [{
					text: aiMessage
				}];
				chatHistory.push({
					role: "model",
					parts: aiParts
				});
				if(activeChatId) {
					await supabase.from('messages').insert({
						conversation_id: activeChatId,
						role: 'model',
						parts: aiParts
					});
				}
			} catch (error) {
				console.error('Gagal Chat:', error);
				const messageElement = placeholder.querySelector('.ai-message-content');
				if(messageElement) {
					messageElement.innerHTML = `<span class="text-red-400 font-medium">Error:</span> <span class="text-gray-300 text-sm">${error.message}</span>`;
				}
				scrollToBottom();
			}
		}
		async function callImageGenAPI(prompt, inputImage = null) {
			const placeholder = addMessage('ai', 'TYPING_PLACEHOLDER');
			const messageContent = placeholder.querySelector('.ai-message-content');
			const statusText = inputImage ? `Mengedit gambar...` : `Membuat gambar...`;
			if(messageContent) {
				messageContent.innerHTML = `
            <div class="flex items-center space-x-2 text-gray-400 italic text-sm">
                <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                <span>${statusText}</span>
            </div>`;
			}
			scrollToBottom();
			const functionUrl = `${SUPABASE_URL}/functions/v1/generate-image`;
			try {
				const {
					data: {
						session
					}
				} = await supabase.auth.getSession();
				if(!session) throw new Error('Sesi tidak valid.');
				const response = await fetch(functionUrl, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${session.access_token}`
					},
					body: JSON.stringify({
						prompt: prompt,
						imageInput: inputImage
					}),
				});
				const data = await response.json();
				if(!response.ok) throw new Error(data.error || "Gagal menghubungi server.");
				let finalContent = "";
				if(data.type === 'image' && data.image_url) {
					finalContent = `<img src="${data.image_url}" class="rounded-lg shadow-lg max-w-full h-auto border border-neutral-700 mt-1" alt="Hasil AI" loading="lazy" />`;
				} else if(data.type === 'text') {
					finalContent = `<div class="p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg text-blue-200 text-sm">
                <strong>Info:</strong> ${markdownConverter.makeHtml(data.text)}
            </div>`;
				} else {
					throw new Error("Respon tidak valid.");
				}
				if(messageContent) {
					messageContent.innerHTML = finalContent;
					const timeElement = placeholder.querySelector('.ai-timestamp');
					if(timeElement) timeElement.textContent = new Date().toLocaleTimeString('id-ID', {
						hour: '2-digit',
						minute: '2-digit'
					});
				}
				scrollToBottom();
				const aiParts = [{
					text: finalContent
				}];
				chatHistory.push({
					role: "model",
					parts: aiParts
				});
				if(activeChatId) {
					await supabase.from('messages').insert({
						conversation_id: activeChatId,
						role: 'model',
						parts: aiParts
					});
				}
			} catch (error) {
				console.error('Gagal generate:', error);
				if(messageContent) {
					messageContent.innerHTML = `<div class="text-red-400 font-medium text-sm border border-red-800 bg-red-900/20 p-2 rounded">Gagal: ${error.message}</div>`;
				}
				scrollToBottom();
			}
		}
		// --- Kompresi Gambar ---
		const compressImage = (file) => {
			return new Promise((resolve) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = (event) => {
					const img = new Image();
					img.src = event.target.result;
					img.onload = () => {
						const canvas = document.createElement('canvas');
						const MAX_WIDTH = 1536;
						const MAX_HEIGHT = 1536;
						let width = img.width;
						let height = img.height;
						if(width > height) {
							if(width > MAX_WIDTH) {
								height *= MAX_WIDTH / width;
								width = MAX_WIDTH;
							}
						} else {
							if(height > MAX_HEIGHT) {
								width *= MAX_HEIGHT / height;
								height = MAX_HEIGHT;
							}
						}
						canvas.width = width;
						canvas.height = height;
						const ctx = canvas.getContext('2d');
						ctx.imageSmoothingEnabled = true;
						ctx.imageSmoothingQuality = 'high';
						ctx.drawImage(img, 0, 0, width, height);
						const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
						const base64Data = dataUrl.split(',')[1];
						resolve({
							mimeType: 'image/jpeg',
							data: base64Data
						});
					};
				};
				reader.onerror = (error) => resolve(null);
			});
		};
		// --- Event Listeners ---
		window.addEventListener('load', () => {
			if(alertModal && alertModal.parentElement === confirmModal) {
				document.body.appendChild(alertModal);
			}
			// Listener Auth
			loginForm.addEventListener('submit', handleLogin);
			logoutButton.addEventListener('click', handleLogout);
			// Listener untuk tombol tambah pengguna
			createUserButton.addEventListener('click', async () => {
				const email = createEmailInput.value;
				const password = createPasswordInput.value;
				if(!email || !password) {
					showCustomAlert("Input Tidak Lengkap", "Silakan masukkan email DAN password.");
					return;
				}
				if(password.length < 6) {
					showCustomAlert("Input Tidak Valid", "Password harus minimal 6 karakter.");
					return;
				}
				createUserButton.disabled = true;
				createUserButton.textContent = "Menambahkan...";
				try {
					await callAdminFunction('create_user', {
						email,
						password
					});
					showCustomAlert("Berhasil", `Pengguna ${email} berhasil dibuat.`);
					createEmailInput.value = '';
					createPasswordInput.value = '';
					loadUsers();
				} catch (error) {
					showCustomAlert("Gagal", `Gagal menambah: ${error.message}`);
				} finally {
					createUserButton.disabled = false;
					createUserButton.textContent = "TAMBAH PENGGUNA";
				}
			});
			// Listener untuk tombol hapus dan freeze
			userListContainer.addEventListener('click', async (e) => {
				const deleteButton = e.target.closest('.delete-user-button');
				const freezeButton = e.target.closest('.freeze-toggle-button');
				if(deleteButton) {
					const userId = deleteButton.dataset.id;
					const userEmail = deleteButton.dataset.email;
					showCustomConfirm("Hapus Pengguna?", `Anda yakin ingin menghapus pengguna ${userEmail} secara permanen? Tindakan ini tidak bisa dibatalkan.`, async () => {
						try {
							deleteButton.textContent = "Menghapus...";
							deleteButton.disabled = true;
							await callAdminFunction('delete_user', {
								id: userId
							});
							await loadUsers();
						} catch (error) {
							console.error("Gagal Hapus Pengguna:", error.message);
							await loadUsers();
						}
					});
				}
				if(freezeButton) {
					const userId = freezeButton.dataset.id;
					const userEmail = freezeButton.dataset.email;
					const action = freezeButton.dataset.action;
					const actionText = action === 'freeze_user' ? 'membekukan' : 'membuka';
					showCustomConfirm(`${actionText.charAt(0).toUpperCase() + actionText.slice(1)} Akun?`, `Anda yakin ingin ${actionText} akun ${userEmail}?`, async () => {
						try {
							freezeButton.textContent = "Memproses...";
							freezeButton.disabled = true;
							await callAdminFunction(action, {
								id: userId
							});
							await loadUsers();
						} catch (error) {
							console.error("Gagal Freeze/Unfreeze:", error.message);
							await loadUsers();
						}
					});
				}
			});
			// Listener Dropdown Kustom
			customModelButton.addEventListener('click', () => {
				customModelOptions.classList.toggle('hidden');
			});
			customModelOptions.addEventListener('click', (e) => {
				if(e.target.classList.contains('custom-model-option')) {
					const selectedValue = e.target.dataset.value;
					const selectedText = e.target.textContent;
					customModelLabel.textContent = selectedText;
					settingsModel.value = selectedValue;
					customModelOptions.classList.add('hidden');
				}
			});
			document.addEventListener('click', (e) => {
				if(!customModelButton.contains(e.target) && !customModelOptions.contains(e.target)) {
					customModelOptions.classList.add('hidden');
				}
			});
			// Listener Halaman Pengaturan
			settingsButton.addEventListener('click', showSettingsPage);
			settingsBackButton.addEventListener('click', () => {
				settingsPage.classList.add('hidden');
				chatApp.classList.remove('hidden');
				scrollToBottom();
			});
			settingsTemp.addEventListener('input', (e) => {
				settingsTempLabel.textContent = e.target.value;
			});
			// Listener Simpan Pengaturan
			settingsForm.addEventListener('submit', async (e) => {
				e.preventDefault();
				const saveButton = document.getElementById('settings-save-button');
				saveButton.disabled = true;
				let cleanPrompt = settingsPrompt.value;
				if(!cleanPrompt) cleanPrompt = "";
				const newSettingsDB = {
					model: settingsModel.value,
					custom_prompt: cleanPrompt,
					temperature: parseFloat(settingsTemp.value),
					max_tokens: parseInt(settingsTokens.value, 10)
				};
				try {
					const {
						error
					} = await supabase.from('global_settings').update(newSettingsDB).eq('id', 1);
					if(error) throw error;
					appSettings.model = newSettingsDB.model;
					appSettings.customPrompt = newSettingsDB.custom_prompt;
					appSettings.temperature = newSettingsDB.temperature;
					appSettings.maxTokens = newSettingsDB.max_tokens;
					showCustomAlert("Berhasil", "Pengaturan telah disimpan!");
				} catch (error) {
					console.error("Gagal menyimpan:", error.message);
					showCustomAlert("Gagal", `Gagal menyimpan: ${error.message}`);
				} finally {
					saveButton.disabled = false;
					saveButton.blur();
				}
			});
			// Listener Sidebar
			sidebarToggleButton.addEventListener('click', openSidebar);
			sidebarOverlay.addEventListener('click', closeSidebar);
			let sidebarSelectedItem = null;
			const chatHistoryList = document.getElementById('chat-history-list');
			// Listener Salin Teks Chat
			chatMessages.addEventListener('click', async (e) => {
				const clickedBubble = e.target.closest('.chat-bubble');
				const clickedCopyButton = e.target.closest('.copy-chat-button');

				if(clickedCopyButton) {
					const bubble = clickedCopyButton.closest('.chat-bubble');
					const messageElement = bubble.querySelector('.ai-message-content');

					if(messageElement) {
						try {
							const tempDiv = document.createElement('div');
							tempDiv.innerHTML = messageElement.innerHTML;

							tempDiv.style.fontFamily = 'Arial, sans-serif';
							tempDiv.style.fontSize = '12pt';
							tempDiv.style.lineHeight = '1.0';
							tempDiv.style.textAlign = 'justify';
							tempDiv.style.color = '#000000';

							const allElements = tempDiv.querySelectorAll('*');
							allElements.forEach(el => {
								el.style.fontFamily = 'Arial, sans-serif';
								el.style.fontSize = '12pt';
								el.style.lineHeight = '1.0';
								if(el.tagName === 'P' || el.tagName === 'LI' || el.tagName === 'DIV') {
									el.style.marginBottom = '6px';
									el.style.textAlign = 'justify';
								}
								if(el.tagName.startsWith('H')) {
									el.style.fontWeight = 'bold';
									el.style.textAlign = 'left';
									el.style.marginTop = '12px';
									el.style.marginBottom = '6px';
								}
							});

							const tables = tempDiv.querySelectorAll('table');
							tables.forEach(table => {
								table.style.width = '100%';
								table.style.borderCollapse = 'collapse';
								table.style.marginTop = '8px';
								table.style.marginBottom = '8px';
								table.style.tableLayout = 'auto';

								table.setAttribute('width', '100%');
								table.setAttribute('border', '1');
								table.setAttribute('cellspacing', '0');
								table.setAttribute('cellpadding', '5');

								const cells = table.querySelectorAll('th, td');
								cells.forEach(cell => {
									cell.style.border = '1px solid #bfbfbf';
									cell.style.padding = '6px';
									cell.style.verticalAlign = 'top';
									cell.style.textAlign = 'left';
								});
								
								const headers = table.querySelectorAll('th');
								headers.forEach(th => {
									th.style.backgroundColor = '#f0f0f0';
									th.style.fontWeight = 'bold';
									th.style.textAlign = 'center';
								});
							});

							const finalHtml = `<div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.0; text-align: justify;">${tempDiv.innerHTML}</div>`;
							const plainText = messageElement.innerText;

							const htmlBlob = new Blob([finalHtml], { type: 'text/html' });
							const textBlob = new Blob([plainText], { type: 'text/plain' });
							const item = new ClipboardItem({
								'text/html': htmlBlob,
								'text/plain': textBlob
							});

							await navigator.clipboard.write([item]);

							const originalIcon = clickedCopyButton.innerHTML;
							clickedCopyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
							clickedCopyButton.classList.remove('text-gray-600');
							clickedCopyButton.classList.add('text-green-500');

							setTimeout(() => {
								clickedCopyButton.innerHTML = originalIcon;
								clickedCopyButton.classList.remove('text-green-500');
								clickedCopyButton.classList.add('text-gray-600');
							}, 1500);

						} catch (err) {
							console.error('Gagal copy:', err);
							navigator.clipboard.writeText(messageElement.innerText);
						}
						return;
					}
				}

				let targetCopyButton = null;
				if(clickedBubble) {
					targetCopyButton = clickedBubble.querySelector('.copy-chat-button');
				}

				document.querySelectorAll('.copy-chat-button').forEach(button => {
					if(button !== targetCopyButton) {
						button.classList.add('invisible');
					}
				});

				if(targetCopyButton) {
					targetCopyButton.classList.toggle('invisible');
				}
			});
			// Keyboard iOS/Safari
			emailInput.addEventListener('blur', forceLayoutRedraw);
			passwordInput.addEventListener('blur', forceLayoutRedraw);
			chatInput.addEventListener('blur', forceLayoutRedraw);
			createEmailInput.addEventListener('blur', forceLayoutRedraw);
			createPasswordInput.addEventListener('blur', forceLayoutRedraw);
			settingsPrompt.addEventListener('blur', forceLayoutRedraw);
			settingsTokens.addEventListener('blur', forceLayoutRedraw);
			// Event Listener Submit Chat
			chatForm.addEventListener('submit', async (e) => {
				e.preventDefault();
				const rawMessage = chatInput.value.trim();
				const lowerMessage = rawMessage.toLowerCase();
				if(!rawMessage && uploadedFiles.length === 0) return;
				const {
					data: {
						user
					}
				} = await supabase.auth.getUser();
				if(!user) {
					showCustomAlert("Sesi Berakhir", "Sesi Anda berakhir.");
					showLoginScreen();
					return;
				}
				// Logika Gambar & Edit
				const isCreateCmd = lowerMessage.startsWith('/gambar ') || lowerMessage.startsWith('@gambar ');
				const isEditCmd = lowerMessage.startsWith('/edit ') || lowerMessage.startsWith('@edit ');
				if(isCreateCmd || isEditCmd) {
					let prompt = '';
					if(isCreateCmd) prompt = rawMessage.substring(8).trim();
					else if(isEditCmd) prompt = rawMessage.substring(6).trim();
					if(!prompt) {
						showCustomAlert("Info", "Mohon tulis deskripsi perintah.");
						return;
					}
					if(isEditCmd && uploadedFiles.length === 0) {
						showCustomAlert("Peringatan", "Wajib upload gambar untuk perintah /edit");
						return;
					}
					let inputImage = null;
					if(uploadedFiles.length > 0) {
						const file = uploadedFiles[0];
						if(!file.isTextContent && file.mimeType.startsWith('image/')) {
							try {
								inputImage = await compressImage(file);
							} catch (err) {
								console.error("Gagal kompres:", err);
								inputImage = {
									mimeType: file.mimeType,
									data: file.data
								};
							}
						}
					}
					chatInput.value = '';
					sendButton.disabled = true;
					filePreviewContainer.innerHTML = '';
					uploadedFiles = [];
					let currentChatId = activeChatId;
					if(isNewChat) {
						try {
							const titlePrefix = isEditCmd ? "Edit: " : "Gambar: ";
							const {
								data: newConvo
							} = await supabase.from('conversations').insert({
								user_id: user.id,
								title: `${titlePrefix}${prompt.substring(0, 20)}...`
							}).select('id, title').single();
							if(newConvo) {
								chatList.unshift(newConvo);
								currentChatId = newConvo.id;
								activeChatId = newConvo.id;
								isNewChat = false;
								renderChatList();
								chatMessages.innerHTML = '';
							}
						} catch (error) {
							return;
						}
					}
					addMessage('user', rawMessage, '');
					const userParts = [{
						text: rawMessage
					}];
					if(inputImage) {
						const actionText = isEditCmd ? "[File dikirim untuk diedit]" : "[File referensi dikirim]";
						userParts.push({
							text: actionText
						});
					}
					chatHistory.push({
						role: "user",
						parts: userParts
					});
					await supabase.from('messages').insert({
						conversation_id: currentChatId,
						role: 'user',
						parts: userParts
					});
					await callImageGenAPI(prompt, inputImage);
					return;
				}
				// Logika Chat Biasa
				const capturedFiles = [...uploadedFiles];
				let currentChatId = activeChatId;
				if(isNewChat && (rawMessage || capturedFiles.length > 0)) {
					let newTitle = rawMessage.substring(0, 30);
					if(!newTitle && capturedFiles.length > 0) newTitle = capturedFiles[0].name.substring(0, 30);
					newTitle += (newTitle.length === 30 ? '...' : '');
					try {
						const {
							data: newConvo,
							error
						} = await supabase.from('conversations').insert({
							user_id: user.id,
							title: newTitle || "Percakapan baru"
						}).select('id, title').single();
						if(error) throw error;
						chatList.unshift(newConvo);
						currentChatId = newConvo.id;
						activeChatId = newConvo.id;
						isNewChat = false;
						renderChatList();
					} catch (error) {
						return;
					}
				}
				if(chatHistory.length === 0) chatMessages.innerHTML = '';
				let filesHtml = '';
				if(capturedFiles.length > 0) {
					filesHtml = filePreviewContainer.innerHTML;
					filePreviewContainer.innerHTML = '';
				}
				addMessage('user', rawMessage, filesHtml);
				const userParts = [];
				if(rawMessage) userParts.push({
					text: rawMessage
				});
				if(filesHtml) userParts.push({
					fileHtml: filesHtml
				});
				chatHistory.push({
					role: "user",
					parts: userParts
				});
				try {
					await supabase.from('messages').insert({
						conversation_id: currentChatId,
						role: 'user',
						parts: userParts
					});
				} catch (error) {}
				chatInput.value = '';
				sendButton.disabled = true;
				uploadedFiles = [];
				await callGeminiAPI(chatHistory, capturedFiles);
			});
			chatInput.addEventListener('input', () => {
				const hasText = chatInput.value.trim().length > 0;
				const hasFiles = uploadedFiles.length > 0;
				sendButton.disabled = !(hasText || hasFiles);
			});
			// Listener Tombol "Percakapan Baru"
			document.getElementById('new-chat-button').addEventListener('click', () => {
				startNewChat();
				closeSidebar();
			});
			// Listener Tombol Modal
			modalCancelButton.addEventListener('click', () => {
				hideConfirmModal();
				currentConfirmAction = () => {};
			});
			modalAgreeButton.addEventListener('click', async () => {
				const actionToRun = currentConfirmAction;
				currentConfirmAction = () => {};
				hideConfirmModal();
				if(typeof actionToRun === 'function') {
					actionToRun();
				}
			});
			// Listener untuk tombol hapus dan buka chat
			chatHistoryList.addEventListener('click', async (e) => {
				const chatItem = e.target.closest('.chat-history-item');
				const deleteButton = e.target.closest('.delete-chat-button');

				if(deleteButton) {
					e.stopPropagation();
					const idToDelete = deleteButton.dataset.id;

					showCustomConfirm("Hapus Percakapan?", "Tindakan ini tidak dapat dibatalkan. Anda yakin ingin menghapus percakapan ini?", async () => {
						if(!idToDelete) return;

						try {
							const {
								data: msgs
							} = await supabase.from('messages').select('parts').eq('conversation_id', idToDelete);

							const filesToRemove = [];
							if(msgs) {
								msgs.forEach(m => {
									m.parts?.forEach(p => {
										if(typeof p.text === 'string' && p.text.includes('/generated-images/')) {
											const match = /generated-images\/([^"'\s\?)]+)/.exec(p.text);
											if(match) filesToRemove.push(decodeURIComponent(match[1]));
										}
									});
								});
							}

							if(filesToRemove.length > 0) await supabase.storage.from('generated-images').remove(filesToRemove);

							const {
								error
							} = await supabase.from('conversations').delete().eq('id', idToDelete);
							if(error) throw error;

							chatList = chatList.filter(chat => chat.id !== idToDelete);
							if(idToDelete == activeChatId) startNewChat(false);
							renderChatList();
							sidebarSelectedItem = null;

							if(chatList.length === 0) {
								closeSidebar();
							}

						} catch (error) {
							console.error("Gagal hapus:", error);
						}
					});
					return;
				}

				if(chatItem) {
					const clickedId = chatItem.dataset.id;
					const thisDeleteButton = chatItem.querySelector('.delete-chat-button');

					if(sidebarSelectedItem === clickedId) {
						if(clickedId !== activeChatId) {
							activeChatId = clickedId;
							isNewChat = false;
							localStorage.setItem('siapip_lastActiveId', activeChatId);
							renderChatList();
							chatMessages.innerHTML = '';

							try {
								const {
									data: messages,
									error
								} = await supabase.from('messages').select('role, parts').eq('conversation_id', activeChatId).order('created_at', {
									ascending: true
								});
								if(error) throw error;

								const history = messages || [];
								if(history.length > 0) {
									history.forEach(msg => {
										const txt = msg.parts.find(p => p.text)?.text || '';
										const file = msg.parts.find(p => p.fileHtml)?.fileHtml;
										addMessage(msg.role === 'user' ? 'user' : 'ai', txt, msg.role === 'user' ? file : true);
									});
								} else {
									addMessage('ai', 'Melanjutkan percakapan...', true);
								}
								scrollToBottom();
							} catch (err) {
								console.error("Gagal buka chat:", err);
								chatMessages.innerHTML = '<div class="text-red-500 text-center mt-5">Gagal memuat pesan.</div>';
							}
						}

						if(thisDeleteButton) thisDeleteButton.classList.add('opacity-0', 'invisible');
						sidebarSelectedItem = null;
						closeSidebar();

					} else {
						document.querySelectorAll('.delete-chat-button').forEach(btn => {
							btn.classList.add('opacity-0', 'invisible');
						});
						if(thisDeleteButton) {
							thisDeleteButton.classList.remove('opacity-0', 'invisible');
						}
						sidebarSelectedItem = clickedId;
					}
				}
			});
			// Listener Sembunyikan Tombol Hapus
			document.addEventListener('click', (e) => {
				const isOutsideList = !e.target.closest('#chat-history-list');
				const isOutsideModal = !e.target.closest('#confirm-modal');
				if(isOutsideList && isOutsideModal) {
					document.querySelectorAll('.delete-chat-button').forEach(btn => {
						btn.classList.add('opacity-0', 'invisible');
						btn.classList.remove('opacity-100');
					});
					sidebarSelectedItem = null;
				}
			}, true);
			// Listener Upload File
			uploadButton.addEventListener('click', () => {
				fileInput.click();
			});
			fileInput.addEventListener('change', async (e) => {
				const selectedFiles = e.target.files;
				if(!selectedFiles.length) return;
				for(const file of selectedFiles) {
					if(!uploadedFiles.find(f => f.name === file.name)) {
						const fileType = file.name.split('.').pop().toLowerCase();
						const isImage = file.type.startsWith('image/');
						const reader = new FileReader();
						const promise = new Promise((resolve, reject) => {
							reader.onload = async (e) => {
								try {
									let content, mimeType, isTextContent = false;
									if(['doc', 'docx'].includes(fileType)) {
										if(typeof mammoth === 'undefined') return reject(new Error("Pustaka .docx (mammoth.js) gagal dimuat."));
										const result = await mammoth.extractRawText({
											arrayBuffer: e.target.result
										});
										content = result.value;
										mimeType = 'text/plain';
										isTextContent = true;
									} else if(['xls', 'xlsx'].includes(fileType)) {
										if(typeof XLSX === 'undefined') return reject(new Error("Pustaka .xlsx (xlsx.js) gagal dimuat."));
										const workbook = XLSX.read(e.target.result, {
											type: 'buffer'
										});
										content = workbook.SheetNames.map(name => XLSX.utils.sheet_to_txt(workbook.Sheets[name])).join('\n\n');
										mimeType = 'text/plain';
										isTextContent = true;
									} else if(fileType === 'pptx') {
										if(typeof JSZip === 'undefined') return reject(new Error("Pustaka .pptx (JSZip) gagal dimuat."));
										const zip = await JSZip.loadAsync(e.target.result);
										const slideTextPromises = [];
										zip.folder("ppt/slides").forEach((relativePath, file) => {
											if(relativePath.startsWith("slide") && relativePath.endsWith(".xml")) {
												slideTextPromises.push(file.async("string").then(extractTextFromSlideXML));
											}
										});
										const slideTexts = await Promise.all(slideTextPromises);
										content = slideTexts.join('\n\n');
										mimeType = 'text/plain';
										isTextContent = true;
									} else if(fileType === 'txt') {
										content = e.target.result;
										mimeType = 'text/plain';
										isTextContent = true;
									} else if(isImage) {
										content = e.target.result.split(',')[1];
										mimeType = file.type;
										isTextContent = false;
									} else if(fileType === 'pdf') {
										content = e.target.result.split(',')[1];
										mimeType = file.type;
										isTextContent = false;
									} else {
										return reject(new Error(`Tipe file .${fileType} tidak didukung.`));
									}
									resolve({
										name: file.name,
										size: file.size,
										type: fileType,
										data: content,
										mimeType: mimeType,
										isTextContent: isTextContent
									});
								} catch (error) {
									reject(error);
								}
							};
							reader.onerror = (error) => reject(error);
							if(isImage || fileType === 'pdf') {
								reader.readAsDataURL(file);
							} else if(fileType === 'txt') {
								reader.readAsText(file);
							} else if(['doc', 'docx', 'xls', 'xlsx', 'pptx'].includes(fileType)) {
								reader.readAsArrayBuffer(file);
							} else {
								reject(new Error(`Tipe file .${fileType} tidak diizinkan.`));
							}
						});
						try {
							const processedFile = await promise;
							if(processedFile) {
								uploadedFiles.push(processedFile);
							}
						} catch (error) {
							console.error("Gagal memproses file:", error);
							showCustomAlert("File Error", `Gagal memproses file "${file.name}": ${error.message}`);
						}
					}
				}
				renderFilePreviews();
				fileInput.value = '';
			});
			// Event Listener Preview File
			filePreviewContainer.addEventListener('click', (e) => {
				const deleteButton = e.target.closest('.delete-file-button');
				if(deleteButton) {
					const indexToRemove = parseInt(deleteButton.dataset.index, 10);
					uploadedFiles.splice(indexToRemove, 1);
					renderFilePreviews();
				}
			});
			// Jalankan pemeriksaan Auth
			checkAuth();
			// Daftarkan Service Worker
			if('serviceWorker' in navigator) {
				navigator.serviceWorker.register('/sw.js').then((registration) => {
					console.log('Service Worker berhasil terdaftar:', registration.scope);
				}).catch((error) => {
					console.error('Pendaftaran Service Worker gagal:', error);
				});
			}
		});
		// Listener untuk tombol OK di modal alert
		alertOkButton.addEventListener('click', hideCustomAlert);
	</script>
</body>
</html>
